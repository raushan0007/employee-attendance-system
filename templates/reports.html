{% extends "base.html" %}

{% block title %}Reports & Analytics - AttendancePro{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-chart-bar me-2"></i>Advanced Reports & Analytics
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="exportReport('pdf')">
                <i class="fas fa-file-pdf me-1"></i>Export PDF
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="exportReport('excel')">
                <i class="fas fa-file-excel me-1"></i>Export Excel
            </button>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="printReport()">
                <i class="fas fa-print me-1"></i>Print Report
            </button>
        </div>
    </div>
</div>

<!-- Quick Stats Cards -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stat-card bg-primary text-white clickable-card" onclick="filterByStatus('present')">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">
                            {% if report_type == 'attendance' %}Total Present{% else %}Approved Leaves{% endif %}
                        </h6>
                        <h3 class="mb-0">
                            {% if report_type == 'attendance' %}
                                {{ analytics.get('present_days', 0) if analytics is defined and analytics else 0 }}
                            {% else %}
                                {{ analytics.get('approved_leaves', 0) if analytics is defined and analytics else 0 }}
                            {% endif %}
                        </h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas {% if report_type == 'attendance' %}fa-user-check{% else %}fa-calendar-check{% endif %} fa-2x opacity-50"></i>
                    </div>
                </div>
                <p class="mb-0 mt-2 small">
                    {% if report_type == 'attendance' %}
                        {% set present_days = analytics.get('present_days', 0) if analytics is defined and analytics else 0 %}
                        {% set total_days = analytics.get('total_days', 1) if analytics is defined and analytics else 1 %}
                        {% set attendance_percentage = (present_days / total_days * 100) if total_days > 0 else 0 %}
                        {{ "%.1f"|format(attendance_percentage) }}% of total days
                    {% else %}
                        Approved leave requests
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stat-card bg-danger text-white clickable-card" onclick="filterByStatus('absent')">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">
                            {% if report_type == 'attendance' %}Total Absent{% else %}Rejected Leaves{% endif %}
                        </h6>
                        <h3 class="mb-0">
                            {% if report_type == 'attendance' %}
                                {{ analytics.get('absent_days', 0) if analytics is defined and analytics else 0 }}
                            {% else %}
                                {{ analytics.get('rejected_leaves', 0) if analytics is defined and analytics else 0 }}
                            {% endif %}
                        </h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas {% if report_type == 'attendance' %}fa-user-times{% else %}fa-calendar-times{% endif %} fa-2x opacity-50"></i>
                    </div>
                </div>
                <p class="mb-0 mt-2 small">
                    {% if report_type == 'attendance' %}
                        {% set absent_days = analytics.get('absent_days', 0) if analytics is defined and analytics else 0 %}
                        {% set total_days = analytics.get('total_days', 1) if analytics is defined and analytics else 1 %}
                        {{ "%.1f"|format((absent_days / total_days * 100)) }}% of total days
                    {% else %}
                        Rejected leave requests
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stat-card bg-warning text-dark clickable-card" onclick="filterByStatus('late')">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">
                            {% if report_type == 'attendance' %}Late Arrivals{% else %}Pending Leaves{% endif %}
                        </h6>
                        <h3 class="mb-0">
                            {% if report_type == 'attendance' %}
                                {{ analytics.get('late_days', 0) if analytics is defined and analytics else 0 }}
                            {% else %}
                                {{ analytics.get('pending_leaves', 0) if analytics is defined and analytics else 0 }}
                            {% endif %}
                        </h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas {% if report_type == 'attendance' %}fa-clock{% else %}fa-calendar-day{% endif %} fa-2x opacity-50"></i>
                    </div>
                </div>
                <p class="mb-0 mt-2 small">
                    {% if report_type == 'attendance' %}
                        {% set late_days = analytics.get('late_days', 0) if analytics is defined and analytics else 0 %}
                        {% set present_days = analytics.get('present_days', 1) if analytics is defined and analytics else 1 %}
                        {{ "%.1f"|format((late_days / present_days * 100)) if present_days > 0 else 0 }}% of present days
                    {% else %}
                        Pending leave requests
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stat-card bg-success text-white clickable-card" onclick="filterByOvertime()">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">
                            {% if report_type == 'attendance' %}Overtime Hours{% else %}Total Leave Days{% endif %}
                        </h6>
                        <h3 class="mb-0">
                            {% if report_type == 'attendance' %}
                                {{ "%.2f"|format(analytics.get('total_overtime', 0)) if analytics is defined and analytics else 0 }}
                            {% else %}
                                {{ analytics.get('total_leave_days', 0) if analytics is defined and analytics else 0 }}
                            {% endif %}
                        </h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas {% if report_type == 'attendance' %}fa-business-time{% else %}fa-calendar-alt{% endif %} fa-2x opacity-50"></i>
                    </div>
                </div>
                <p class="mb-0 mt-2 small">
                    {% if report_type == 'attendance' %}Across all employees{% else %}Total days on leave{% endif %}
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Analytics Cards -->
<div class="row mb-4">
    <div class="col-lg-4 col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-transparent">
                <h6 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>
                    {% if report_type == 'attendance' %}Attendance Distribution{% else %}Leave Status Distribution{% endif %}
                </h6>
            </div>
            <div class="card-body">
                <canvas id="analyticsPieChart" height="250"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4 col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-transparent">
                <h6 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>
                    {% if report_type == 'attendance' %}Daily Attendance Trend{% else %}Monthly Leave Trend{% endif %}
                </h6>
            </div>
            <div class="card-body">
                <canvas id="trendChart" height="250"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4 col-md-12 mb-4">
        <div class="card h-100">
            <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="fas fa-users me-2"></i>
                    {% if report_type == 'attendance' %}Department Performance{% else %}Department Leave Summary{% endif %}
                </h6>
                <span class="badge bg-primary">{{ employees|length }} Employees</span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-borderless">
                        <thead>
                            <tr>
                                <th>Department</th>
                                <th>Employees</th>
                                {% if report_type == 'attendance' %}
                                <th>Avg. Hours</th>
                                <th>Performance</th>
                                {% else %}
                                <th>Leave Days</th>
                                <th>Avg. per Emp</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% set dept_stats = {} %}
                            {% for employee in employees %}
                                {% if employee.department not in dept_stats %}
                                    {% if report_type == 'attendance' %}
                                        {% set _ = dept_stats.update({employee.department: {'count': 0, 'total_hours': 0, 'records': 0}}) %}
                                    {% else %}
                                        {% set _ = dept_stats.update({employee.department: {'count': 0, 'total_days': 0}}) %}
                                    {% endif %}
                                {% endif %}
                                {% set _ = dept_stats[employee.department].update({'count': dept_stats[employee.department].count + 1}) %}
                                
                                {% if report_type == 'attendance' %}
                                    {% for record in report_data %}
                                        {% if record.user_id == employee.id %}
                                            {% set _ = dept_stats[employee.department].update({
                                                'total_hours': dept_stats[employee.department].total_hours + (record.total_hours or 0),
                                                'records': dept_stats[employee.department].records + 1
                                            }) %}
                                        {% endif %}
                                    {% endfor %}
                                {% else %}
                                    {% for record in report_data %}
                                        {% if record.user_id == employee.id %}
                                            {% set leave_duration = (record.end_date - record.start_date).days + 1 %}
                                            {% set _ = dept_stats[employee.department].update({
                                                'total_days': dept_stats[employee.department].total_days + leave_duration
                                            }) %}
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                            {% endfor %}
                            
                            {% for dept, stats in dept_stats.items() %}
                            <tr>
                                <td>{{ dept }}</td>
                                <td>{{ stats.count }}</td>
                                {% if report_type == 'attendance' %}
                                <td>
                                    {% if stats.records > 0 %}
                                        {{ "%.1f"|format(stats.total_hours / stats.records) }}h
                                    {% else %}
                                        0h
                                    {% endif %}
                                </td>
                                <td>
                                    {% if stats.records > 0 %}
                                        {% set avg_hours = stats.total_hours / stats.records %}
                                        {% if avg_hours >= 8 %}
                                            <span class="badge bg-success">Excellent</span>
                                        {% elif avg_hours >= 7 %}
                                            <span class="badge bg-info">Good</span>
                                        {% elif avg_hours >= 6 %}
                                            <span class="badge bg-warning">Average</span>
                                        {% else %}
                                            <span class="badge bg-danger">Poor</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="badge bg-secondary">No Data</span>
                                    {% endif %}
                                </td>
                                {% else %}
                                <td>{{ stats.total_days }}</td>
                                <td>
                                    {% if stats.count > 0 %}
                                        {{ "%.1f"|format(stats.total_days / stats.count) }}
                                    {% else %}
                                        0
                                    {% endif %}
                                </td>
                                {% endif %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- The rest of your template remains exactly the same from the Filters Card section onward -->

<!-- Filters Card -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">Report Filters</h5>
        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#filterCollapse">
            <i class="fas fa-sliders-h me-1"></i>Toggle Filters
        </button>
    </div>
    <div class="collapse show" id="filterCollapse">
        <div class="card-body">
            <form method="GET" class="row g-3" id="reportFilterForm">
                <div class="col-md-3">
                    <label class="form-label">Report Type</label>
                    <select class="form-select" name="report_type" id="reportType">
                        <option value="attendance" {% if report_type == 'attendance' %}selected{% endif %}>Attendance Report</option>
                        <option value="leaves" {% if report_type == 'leaves' %}selected{% endif %}>Leave Report</option>
                    </select>
                </div>
                
                <div class="col-md-3">
                    <label class="form-label">Start Date</label>
                    <input type="date" class="form-control" name="start_date" 
                           value="{{ start_date.strftime('%Y-%m-%d') if start_date else '' }}" id="startDate">
                </div>
                
                <div class="col-md-3">
                    <label class="form-label">End Date</label>
                    <input type="date" class="form-control" name="end_date" 
                           value="{{ end_date.strftime('%Y-%m-%d') if end_date else '' }}" id="endDate">
                </div>
                
                <div class="col-md-3">
                    <label class="form-label">Employee</label>
                    <select class="form-select" name="employee_id" id="employeeSelect">
                        <option value="all">All Employees</option>
                        {% for employee in employees %}
                        <option value="{{ employee.id }}" {% if selected_employee == employee.id|string %}selected{% endif %}>
                            {{ employee.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-12">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-filter me-1"></i>Generate Report
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="resetFilters()">
                        <i class="fas fa-redo me-1"></i>Reset
                    </button>
                    <button type="button" class="btn btn-outline-info" onclick="applyQuickFilter('today')">
                        <i class="fas fa-calendar-day me-1"></i>Today
                    </button>
                    <button type="button" class="btn btn-outline-info" onclick="applyQuickFilter('week')">
                        <i class="fas fa-calendar-week me-1"></i>This Week
                    </button>
                    <button type="button" class="btn btn-outline-info" onclick="applyQuickFilter('month')">
                        <i class="fas fa-calendar-alt me-1"></i>This Month
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Detailed Report Data -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
            {% if report_type == 'attendance' %}Attendance Records{% else %}Leave Records{% endif %}
            ({{ start_date }} to {{ end_date }})
            <span class="badge bg-primary ms-2" id="recordCount">{{ report_data|length }} records</span>
        </h5>
        <div class="btn-group">
            <button class="btn btn-sm btn-outline-primary" onclick="exportReport('csv')">
                <i class="fas fa-download me-1"></i>Export CSV
            </button>
            <div class="btn-group">
                <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="fas fa-cog me-1"></i>Options
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="toggleColumn('check_in')">Toggle Check-in Times</a></li>
                    <li><a class="dropdown-item" href="#" onclick="toggleColumn('location')">Toggle Location Data</a></li>
                    <li><a class="dropdown-item" href="#" onclick="toggleColumn('overtime')">Toggle Overtime</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#" onclick="showAllColumns()">Show All Columns</a></li>
                    <li><a class="dropdown-item" href="#" onclick="hideAllColumns()">Hide All Columns</a></li>
                </ul>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover table-striped" id="reportTable">
                <thead class="table-dark">
                    {% if report_type == 'attendance' %}
                    <tr>
                        <th>Date</th>
                        <th>Employee</th>
                        <th data-column="check_in">Check In</th>
                        <th data-column="lunch">Lunch</th>
                        <th data-column="check_out">Check Out</th>
                        <th>Total Hours</th>
                        <th data-column="overtime">Overtime</th>
                        <th data-column="location">Location</th>
                        <th>City</th>
                        <th>Status</th>
                        <th>Late</th>
                        <th>Actions</th>
                    </tr>
                    {% else %}
                    <tr>
                        <th>Employee</th>
                        <th>Leave Type</th>
                        <th>Start Date</th>
                        <th>End Date</th>
                        <th>Duration</th>
                        <th>Reason</th>
                        <th>Applied On</th>
                        <th>Status</th>
                        <th>Approved By</th>
                        <th>Actions</th>
                    </tr>
                    {% endif %}
                </thead>
                <tbody>
                    {% if report_type == 'attendance' %}
                    {% for record in report_data %}
                    <tr data-status="{{ record.status }}" data-late="{{ 'true' if record.is_late else 'false' }}" data-overtime="{{ record.overtime_hours or 0 }}">
                        <td>{{ record.date }}</td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-user-circle me-2 text-primary"></i>
                                </div>
                                <div class="flex-grow-1 ms-2">
                                    {{ record.user.name }}
                                    <div class="small text-muted">{{ record.user.department }}</div>
                                </div>
                            </div>
                        </td>
                        <td data-column="check_in">
                            {% if record.check_in %}
                                {{ record.check_in.strftime('%H:%M') }}
                                {% if record.is_late %}
                                    <span class="badge bg-warning ms-1">Late</span>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">N/A</span>
                            {% endif %}
                        </td>
                        <td data-column="lunch">
                            {% if record.lunch_start and record.lunch_end %}
                                {{ record.lunch_start.strftime('%H:%M') }} - {{ record.lunch_end.strftime('%H:%M') }}
                            {% else %}
                                <span class="text-muted">N/A</span>
                            {% endif %}
                        </td>
                        <td data-column="check_out">
                            {{ record.check_out.strftime('%H:%M') if record.check_out else 'N/A' }}
                        </td>
                        <td>
                            <span class="fw-bold">{{ "%.2f"|format(record.total_hours) if record.total_hours else '0.00' }} hrs</span>
                        </td>
                        <td data-column="overtime">
                            {% if record.overtime_hours and record.overtime_hours > 0 %}
                                <span class="badge bg-success">{{ "%.2f"|format(record.overtime_hours) }} hrs</span>
                            {% else %}
                                <span class="text-muted">None</span>
                            {% endif %}
                        </td>
                        <td data-column="location">
                            {{ record.location or 'N/A' }}
                        </td>
                        <td>
                            {% if record.city %}
                            <span class="badge bg-info">{{ record.city }}</span>
                            {% else %}
                            <span class="text-muted">N/A</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge {% if record.status == 'present' %}bg-success{% elif record.status == 'half-day' %}bg-warning{% else %}bg-danger{% endif %}">
                                {{ record.status|replace('-', ' ')|title }}
                            </span>
                        </td>
                        <td>
                            {% if record.is_late %}
                                <i class="fas fa-clock text-warning" title="Late Arrival"></i>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="viewRecordDetails({{ record.id }})" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                {% if session['user_role'] == 'admin' %}
                                <a href="{{ url_for('edit_attendance', attendance_id=record.id) }}" class="btn btn-outline-secondary" title="Edit Record">
                                    <i class="fas fa-edit"></i>
                                </a>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    {% for record in report_data %}
                    <tr>
                        <td>{{ record.user.name }}</td>
                        <td>
                            <span class="badge {% if record.leave_type == 'Sick' %}bg-info{% elif record.leave_type == 'Vacation' %}bg-success{% else %}bg-secondary{% endif %}">
                                {{ record.leave_type }}
                            </span>
                        </td>
                        <td>{{ record.start_date }}</td>
                        <td>{{ record.end_date }}</td>
                        <td>{{ (record.end_date - record.start_date).days + 1 }} days</td>
                        <td>
                            {% if record.reason %}
                                <span class="d-inline-block text-truncate" style="max-width: 150px;" title="{{ record.reason }}">
                                    {{ record.reason }}
                                </span>
                            {% else %}
                                <span class="text-muted">No reason provided</span>
                            {% endif %}
                        </td>
                        <td>{{ record.applied_date.strftime('%Y-%m-%d') }}</td>
                        <td>
                            <span class="badge {% if record.status == 'approved' %}bg-success{% elif record.status == 'pending' %}bg-warning{% else %}bg-danger{% endif %}">
                                {{ record.status|title }}
                            </span>
                        </td>
                        <td>{{ record.approver.name if record.approver else 'N/A' }}</td>
                        <td>
                            <button class="btn btn-outline-primary btn-sm" onclick="viewLeaveDetails({{ record.id }})">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                    {% endif %}
                </tbody>
            </table>
        </div>
        
        {% if not report_data %}
        <div class="text-center py-5">
            <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">No data found for the selected filters</h5>
            <p class="text-muted">Try adjusting your filter criteria</p>
        </div>
        {% endif %}
        
        <!-- Pagination -->
        {% if report_data and report_data|length > 10 %}
        <nav aria-label="Report pagination">
            <ul class="pagination justify-content-center mt-4">
                <li class="page-item disabled">
                    <a class="page-link" href="#" tabindex="-1">Previous</a>
                </li>
                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                <li class="page-item"><a class="page-link" href="#">2</a></li>
                <li class="page-item"><a class="page-link" href="#">3</a></li>
                <li class="page-item">
                    <a class="page-link" href="#">Next</a>
                </li>
            </ul>
        </nav>
        {% endif %}
    </div>
</div>

<!-- Record Details Modal -->
<div class="modal fade" id="recordDetailsModal" tabindex="-1" aria-labelledby="recordDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="recordDetailsModalLabel">Attendance Record Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="recordDetailsContent">
                <!-- Content will be loaded via JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="printRecord()">Print</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Initialize charts when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    updateRecordCount();
    
    // Make cards clickable
    document.querySelectorAll('.clickable-card').forEach(card => {
        card.style.cursor = 'pointer';
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-5px)';
            this.style.transition = 'transform 0.2s';
        });
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });
});

function initializeCharts() {
    // Check if charts exist on the page
    const pieChartEl = document.getElementById('analyticsPieChart');
    const trendChartEl = document.getElementById('trendChart');
    
    if (!pieChartEl || !trendChartEl) return;
    
    // Determine report type for chart data
    const reportType = '{{ report_type }}';
    
    if (reportType === 'attendance') {
        // Attendance Distribution Pie Chart
        const pieCtx = pieChartEl.getContext('2d');
        new Chart(pieCtx, {
            type: 'pie',
            data: {
                labels: ['Present', 'Absent', 'Half Days', 'Late Arrivals'],
                datasets: [{
                    data: [{{ analytics.get('present_days', 0) }}, 
                           {{ analytics.get('absent_days', 0) }}, 
                           {{ analytics.get('half_days', 0) }}, 
                           {{ analytics.get('late_days', 0) }}],
                    backgroundColor: [
                        'rgba(40, 167, 69, 0.8)',
                        'rgba(220, 53, 69, 0.8)',
                        'rgba(255, 193, 7, 0.8)',
                        'rgba(23, 162, 184, 0.8)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    } else {
        // Leave Status Distribution Pie Chart
        const pieCtx = pieChartEl.getContext('2d');
        new Chart(pieCtx, {
            type: 'pie',
            data: {
                labels: ['Approved', 'Rejected', 'Pending'],
                datasets: [{
                    data: [{{ analytics.get('approved_leaves', 0) }}, 
                           {{ analytics.get('rejected_leaves', 0) }}, 
                           {{ analytics.get('pending_leaves', 0) }}],
                    backgroundColor: [
                        'rgba(40, 167, 69, 0.8)',
                        'rgba(220, 53, 69, 0.8)',
                        'rgba(255, 193, 7, 0.8)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }
    
    // Trend Chart (generic implementation)
    const trendCtx = trendChartEl.getContext('2d');
    new Chart(trendCtx, {
        type: 'line',
        data: {
            labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
            datasets: [{
                label: reportType === 'attendance' ? 'Present Employees' : 'Leave Applications',
                data: [12, 19, 15, 17],
                borderColor: 'rgba(40, 167, 69, 1)',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

// Rest of your JavaScript functions remain exactly the same...
function filterByStatus(status) {
    const rows = document.querySelectorAll('#reportTable tbody tr');
    let visibleCount = 0;
    
    rows.forEach(row => {
        if (status === 'all' || row.getAttribute('data-status') === status) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    document.getElementById('recordCount').textContent = `${visibleCount} records`;
    showToast(`Filtered by: ${status.charAt(0).toUpperCase() + status.slice(1)}`, 'info');
}

function filterByOvertime() {
    const rows = document.querySelectorAll('#reportTable tbody tr');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const overtime = parseFloat(row.getAttribute('data-overtime'));
        if (overtime > 0) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    document.getElementById('recordCount').textContent = `${visibleCount} records`;
    showToast('Filtered by: Overtime Hours', 'info');
}

function resetFilters() {
    window.location.href = "{{ url_for('reports') }}";
}

function applyQuickFilter(range) {
    const today = new Date();
    let startDate, endDate;
    
    switch(range) {
        case 'today':
            startDate = endDate = today.toISOString().split('T')[0];
            break;
        case 'week':
            startDate = new Date(today.setDate(today.getDate() - today.getDay() + 1)).toISOString().split('T')[0];
            endDate = new Date().toISOString().split('T')[0];
            break;
        case 'month':
            startDate = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
            endDate = new Date().toISOString().split('T')[0];
            break;
    }
    
    document.getElementById('startDate').value = startDate;
    document.getElementById('endDate').value = endDate;
    document.getElementById('reportFilterForm').submit();
}

function toggleColumn(columnName) {
    const cells = document.querySelectorAll(`[data-column="${columnName}"]`);
    const isVisible = cells[0].style.display !== 'none';
    
    cells.forEach(cell => {
        cell.style.display = isVisible ? 'none' : '';
    });
    
    showToast(`${isVisible ? 'Hidden' : 'Shown'} ${columnName.replace('_', ' ')} column`, 'info');
}

function showAllColumns() {
    document.querySelectorAll('[data-column]').forEach(cell => {
        cell.style.display = '';
    });
    showToast('All columns shown', 'success');
}

function hideAllColumns() {
    document.querySelectorAll('[data-column]').forEach(cell => {
        cell.style.display = 'none';
    });
    showToast('All optional columns hidden', 'info');
}

function updateRecordCount() {
    const visibleRows = document.querySelectorAll('#reportTable tbody tr:not([style*="display: none"])');
    document.getElementById('recordCount').textContent = `${visibleRows.length} records`;
}

function viewRecordDetails(recordId) {
    // Simplified implementation
    showToast('Viewing record details for ID: ' + recordId, 'info');
}

function viewLeaveDetails(leaveId) {
    showToast('Viewing leave details for ID: ' + leaveId, 'info');
}

function exportReport(format) {
    showToast(`Exporting report as ${format.toUpperCase()}`, 'info');
}

function printReport() {
    window.print();
}

function printRecord() {
    showToast('Printing record details...', 'info');
}

function showToast(message, type = 'info') {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-bg-${type} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
    bsToast.show();
    
    // Remove toast after it's hidden
    toast.addEventListener('hidden.bs.toast', function() {
        document.body.removeChild(toast);
    });
}
</script>

<style>
.stat-card {
    transition: all 0.3s ease;
    border: none;
    border-radius: 10px;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.1);
}

.clickable-card {
    cursor: pointer;
}

.table-responsive {
    max-height: 600px;
}

/* Print styles */
@media print {
    .btn, .card-header .btn-group, .pagination {
        display: none !important;
    }
    
    .card {
        border: none !important;
        box-shadow: none !important;
    }
}
</style>
{% endblock %}