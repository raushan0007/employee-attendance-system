{% extends "base.html" %}

{% block title %}{% if is_admin %}Leave Management{% else %}My Leaves{% endif %} - AttendancePro{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-4 border-bottom">
    <div>
        <h1 class="h2 mb-1">
            <i class="fas fa-calendar-alt me-2 text-primary"></i>
            {% if is_admin %}Leave Management Dashboard{% else %}My Leave Applications{% endif %}
        </h1>
        <p class="text-muted mb-0">
            {% if is_admin %}
                Manage and track all employee leave requests
            {% else %}
                View your leave history and apply for new leaves
            {% endif %}
        </p>
    </div>
    {% if not is_admin %}
    <button class="btn btn-primary btn-lg px-4" data-bs-toggle="modal" data-bs-target="#applyLeaveModal">
        <i class="fas fa-plus me-2"></i>Apply for Leave
    </button>
    {% endif %}
</div>

<!-- Statistics Cards -->
{% if is_admin %}
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-start-lg border-primary clickable-card" data-filter-status="pending" style="cursor: pointer;">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <div class="text-xs fw-bold text-primary text-uppercase mb-1">Pending Requests</div>
                        <div class="h5 mb-0 fw-bold text-gray-800">{{ pending_count }}</div>
                        <div class="text-xs text-muted">Click to filter pending</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-clock fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-start-lg border-success clickable-card" data-filter-status="approved" style="cursor: pointer;">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <div class="text-xs fw-bold text-success text-uppercase mb-1">Approved This Month</div>
                        <div class="h5 mb-0 fw-bold text-gray-800">{{ approved_this_month }}</div>
                        <div class="text-xs text-muted">Click to filter approved</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-start-lg border-danger clickable-card" data-filter-status="rejected" style="cursor: pointer;">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <div class="text-xs fw-bold text-danger text-uppercase mb-1">Rejected This Month</div>
                        <div class="h5 mb-0 fw-bold text-gray-800">{{ rejected_this_month }}</div>
                        <div class="text-xs text-muted">Click to filter rejected</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-times-circle fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-start-lg border-info clickable-card" data-filter-status="all" style="cursor: pointer;">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <div class="text-xs fw-bold text-info text-uppercase mb-1">Total Applications</div>
                        <div class="h5 mb-0 fw-bold text-gray-800">{{ total_applications }}</div>
                        <div class="text-xs text-muted">Click to show all</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-list fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="row mb-4">
    <div class="col-md-4 mb-3">
        <div class="card bg-primary text-white clickable-card" data-filter-status="all" style="cursor: pointer;">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <div class="text-xs fw-bold text-white-50 text-uppercase mb-1">Remaining Leaves</div>
                        <div class="h5 mb-0 fw-bold">{{ remaining_leaves }}</div>
                        <div class="text-xs text-white-50">Click to show all</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-calendar-check fa-2x text-white-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card bg-success text-white clickable-card" data-filter-status="approved" style="cursor: pointer;">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <div class="text-xs fw-bold text-white-50 text-uppercase mb-1">Approved This Year</div>
                        <div class="h5 mb-0 fw-bold">{{ approved_this_year }}</div>
                        <div class="text-xs text-white-50">Click to filter approved</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-check fa-2x text-white-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card bg-info text-white clickable-card" data-filter-status="pending" style="cursor: pointer;">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <div class="text-xs fw-bold text-white-50 text-uppercase mb-1">Pending Requests</div>
                        <div class="h5 mb-0 fw-bold">{{ user_pending_count }}</div>
                        <div class="text-xs text-white-50">Click to filter pending</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-clock fa-2x text-white-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Enhanced Filter and Search Section -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-light py-3">
        <div class="row align-items-center">
            <div class="col-md-4">
                <h5 class="card-title mb-0">
                    <i class="fas fa-filter me-2 text-primary"></i>
                    {% if is_admin %}All Leave Applications{% else %}My Leave Applications{% endif %}
                </h5>
            </div>
            <div class="col-md-8">
                <div class="row g-2">
                    <div class="col-md-3">
                        <select class="form-select form-select-sm" id="statusFilter">
                            <option value="">All Statuses</option>
                            <option value="pending">Pending</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input type="date" class="form-control form-control-sm" id="startDateFilter" placeholder="From Date">
                    </div>
                    <div class="col-md-3">
                        <input type="date" class="form-control form-control-sm" id="endDateFilter" placeholder="To Date">
                    </div>
                    <div class="col-md-3">
                        <div class="input-group input-group-sm">
                            <input type="text" class="form-control" placeholder="Search..." id="searchInput">
                            <button class="btn btn-outline-secondary" type="button" id="clearFilters">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-striped mb-0" id="leavesTable">
                <thead class="table-light">
                    <tr>
                        {% if is_admin %}<th>Employee</th>{% endif %}
                        <th>Leave Type</th>
                        <th>Start Date</th>
                        <th>End Date</th>
                        <th>Duration</th>
                        <th>Applied On</th>
                        <th>Status</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for leave in leaves %}
                    <tr data-status="{{ leave.status }}" data-start-date="{{ leave.start_date.strftime('%Y-%m-%d') }}" data-end-date="{{ leave.end_date.strftime('%Y-%m-%d') }}" data-applied-date="{{ leave.applied_date.strftime('%Y-%m-%d') }}">
                        {% if is_admin %}
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm me-2">
                                    <div class="avatar-title bg-light rounded-circle text-primary fw-bold">
                                        {{ leave.user.name[0] }}
                                    </div>
                                </div>
                                <div>
                                    <strong>{{ leave.user.name }}</strong>
                                    <div class="text-muted small">{{ leave.user.department }}</div>
                                </div>
                            </div>
                        </td>
                        {% endif %}
                        <td>
                            <span class="badge bg-light text-dark border">
                                <i class="fas fa-{{ 'umbrella-beach' if leave.leave_type == 'Vacation' else 'heartbeat' if leave.leave_type == 'Sick Leave' else 'user-clock' if leave.leave_type == 'Personal Leave' else 'exclamation-triangle' if leave.leave_type == 'Emergency Leave' else 'baby' }} me-1"></i>
                                {{ leave.leave_type }}
                            </span>
                        </td>
                        <td>
                            <span class="fw-bold">{{ leave.start_date.strftime('%d %b %Y') }}</span>
                        </td>
                        <td>
                            <span class="fw-bold">{{ leave.end_date.strftime('%d %b %Y') }}</span>
                        </td>
                        <td>
                            {% set duration = (leave.end_date - leave.start_date).days + 1 %}
                            <span class="badge bg-light text-dark">
                                {{ duration }} day{% if duration > 1 %}s{% endif %}
                            </span>
                        </td>
                        <td>
                            <small class="text-muted">{{ leave.applied_date.strftime('%d %b %Y') }}</small>
                        </td>
                        <td>
                            {% if leave.status == 'approved' %}
                            <span class="badge bg-success rounded-pill">
                                <i class="fas fa-check me-1"></i>Approved
                            </span>
                            {% elif leave.status == 'rejected' %}
                            <span class="badge bg-danger rounded-pill">
                                <i class="fas fa-times me-1"></i>Rejected
                            </span>
                            {% else %}
                            <span class="badge bg-warning rounded-pill">
                                <i class="fas fa-clock me-1"></i>Pending
                            </span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="d-flex justify-content-center">
                                <div class="btn-group btn-group-sm" role="group">
                                    <button class="btn btn-outline-primary view-details" data-bs-toggle="modal" 
                                            data-bs-target="#leaveDetailsModal{{ leave.id }}">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                    {% if is_admin and leave.status == 'pending' %}
                                    <button class="btn btn-outline-success approve-leave" data-leave-id="{{ leave.id }}">
                                        <i class="fas fa-check"></i> Approve
                                    </button>
                                    <button class="btn btn-outline-danger reject-leave" data-bs-toggle="modal" 
                                            data-bs-target="#rejectLeaveModal" data-leave-id="{{ leave.id }}">
                                        <i class="fas fa-times"></i> Reject
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                    
                    {% if leaves|length == 0 %}
                    <tr>
                        <td colspan="{% if is_admin %}8{% else %}7{% endif %}" class="text-center py-5">
                            <div class="py-4">
                                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">No leave applications found</h5>
                                <p class="text-muted">
                                    {% if is_admin %}
                                    There are no leave applications to display at the moment.
                                    {% else %}
                                    You haven't applied for any leaves yet.
                                    {% endif %}
                                </p>
                                {% if not is_admin %}
                                <button class="btn btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#applyLeaveModal">
                                    <i class="fas fa-plus me-1"></i>Apply for your first leave
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
    <div class="card-footer bg-light py-3">
        <div class="d-flex justify-content-between align-items-center">
            <div class="text-muted small">
                Showing <strong id="visibleCount">{{ leaves|length }}</strong> of <strong>{{ leaves|length }}</strong> leave application{% if leaves|length != 1 %}s{% endif %}
            </div>
            {% if leaves|length > 10 %}
            <nav>
                <ul class="pagination pagination-sm mb-0">
                    <li class="page-item disabled">
                        <a class="page-link" href="#">Previous</a>
                    </li>
                    <li class="page-item active"><a class="page-link" href="#">1</a></li>
                    <li class="page-item"><a class="page-link" href="#">2</a></li>
                    <li class="page-item"><a class="page-link" href="#">3</a></li>
                    <li class="page-item">
                        <a class="page-link" href="#">Next</a>
                    </li>
                </ul>
            </nav>
            {% endif %}
        </div>
    </div>
</div>

<!-- Leave Details Modals -->
{% for leave in leaves %}
<div class="modal fade" id="leaveDetailsModal{{ leave.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-file-alt me-2"></i>Leave Application Details
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label fw-bold text-muted small mb-1">Employee</label>
                            <p class="mb-0">{{ leave.user.name }}</p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold text-muted small mb-1">Department</label>
                            <p class="mb-0">{{ leave.user.department }}</p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold text-muted small mb-1">Leave Type</label>
                            <p class="mb-0">
                                <span class="badge bg-light text-dark">
                                    {{ leave.leave_type }}
                                </span>
                            </p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label fw-bold text-muted small mb-1">Period</label>
                            <p class="mb-0">{{ leave.start_date.strftime('%d %b %Y') }} to {{ leave.end_date.strftime('%d %b %Y') }}</p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold text-muted small mb-1">Duration</label>
                            <p class="mb-0">
                                {% set duration = (leave.end_date - leave.start_date).days + 1 %}
                                {{ duration }} day{% if duration > 1 %}s{% endif %}
                            </p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold text-muted small mb-1">Applied On</label>
                            <p class="mb-0">{{ leave.applied_date.strftime('%d %b %Y') }}</p>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold text-muted small mb-1">Reason</label>
                    <div class="card bg-light">
                        <div class="card-body">
                            <p class="mb-0">{{ leave.reason or 'No reason provided' }}</p>
                        </div>
                    </div>
                </div>
                
                {% if leave.emergency_contact %}
                <div class="mb-3">
                    <label class="form-label fw-bold text-muted small mb-1">Emergency Contact</label>
                    <p class="mb-0">
                        <i class="fas fa-phone me-2 text-muted"></i>{{ leave.emergency_contact }}
                    </p>
                </div>
                {% endif %}
                
                {% if leave.approved_by %}
                <div class="mb-3">
                    <label class="form-label fw-bold text-muted small mb-1">Approved By</label>
                    <p class="mb-0">
                        <i class="fas fa-user-check me-2 text-success"></i>{{ leave.approver.name }}
                    </p>
                </div>
                {% endif %}
                
                {% if leave.reject_reason %}
                <div class="mb-3">
                    <label class="form-label fw-bold text-muted small mb-1">Rejection Reason</label>
                    <div class="card bg-light border-danger">
                        <div class="card-body">
                            <p class="mb-0 text-danger">{{ leave.reject_reason }}</p>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                {% if is_admin and leave.status == 'pending' %}
                <button class="btn btn-success" onclick="approveLeave({{ leave.id }})">
                    <i class="fas fa-check me-1"></i>Approve
                </button>
                <button class="btn btn-danger" data-bs-toggle="modal" 
                        data-bs-target="#rejectLeaveModal" onclick="setRejectLeaveId({{ leave.id }})">
                    <i class="fas fa-times me-1"></i>Reject
                </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endfor %}

<!-- Apply Leave Modal (for employees) -->
{% if not is_admin %}
<div class="modal fade" id="applyLeaveModal" tabindex="-1" aria-labelledby="applyLeaveModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('apply_leave') }}" id="leaveForm">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="applyLeaveModalLabel">
                        <i class="fas fa-calendar-plus me-2"></i>Apply for Leave
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Leave Type <span class="text-danger">*</span></label>
                                <select class="form-select" name="leave_type" required>
                                    <option value="">Select leave type</option>
                                    <option value="Sick Leave">Sick Leave</option>
                                    <option value="Vacation">Vacation</option>
                                    <option value="Personal Leave">Personal Leave</option>
                                    <option value="Emergency Leave">Emergency Leave</option>
                                    <option value="Maternity/Paternity">Maternity/Paternity Leave</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Remaining Leaves</label>
                                <div class="alert alert-light mb-0">
                                    <div class="d-flex justify-content-between">
                                        <span>Available:</span>
                                        <span class="fw-bold">{{ remaining_leaves }} days</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Start Date <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" name="start_date" id="startDate" required 
                                       min="{{ today.strftime('%Y-%m-%d') }}">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">End Date <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" name="end_date" id="endDate" required 
                                       min="{{ today.strftime('%Y-%m-%d') }}">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="alert alert-info" id="durationAlert" style="display: none;">
                            <i class="fas fa-info-circle me-2"></i>
                            <span id="durationText">Leave duration: 0 days</span>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Reason <span class="text-danger">*</span></label>
                        <textarea class="form-control" name="reason" rows="4" required 
                                  placeholder="Please provide a detailed reason for your leave application..."></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Emergency Contact</label>
                        <input type="text" class="form-control" name="emergency_contact" 
                               placeholder="Emergency contact number (optional)">
                        <div class="form-text">Provide an emergency contact number if you'll be unavailable during your leave.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane me-1"></i>Submit Application
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- Reject Leave Modal (for admins) -->
{% if is_admin %}
<div class="modal fade" id="rejectLeaveModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-times-circle me-2"></i>Reject Leave Application
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="rejectLeaveId">
                <p class="text-muted">Please provide a reason for rejecting this leave application.</p>
                <div class="mb-3">
                    <label class="form-label fw-bold">Reason for Rejection <span class="text-danger">*</span></label>
                    <textarea class="form-control" id="rejectReason" rows="4" required 
                              placeholder="Provide a clear and constructive reason for rejection..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmReject()">
                    <i class="fas fa-times me-1"></i>Reject Leave
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// Global function to set reject leave ID
function setRejectLeaveId(leaveId) {
    document.getElementById('rejectLeaveId').value = leaveId;
}

// Calculate and display leave duration
document.addEventListener('DOMContentLoaded', function() {
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const durationAlert = document.getElementById('durationAlert');
    const durationText = document.getElementById('durationText');
    
    if (startDateInput && endDateInput) {
        function calculateDuration() {
            const startDate = new Date(startDateInput.value);
            const endDate = new Date(endDateInput.value);
            
            if (startDate && endDate && startDate <= endDate) {
                const duration = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
                durationText.textContent = `Leave duration: ${duration} day${duration !== 1 ? 's' : ''}`;
                durationAlert.style.display = 'block';
            } else {
                durationAlert.style.display = 'none';
            }
        }
        
        startDateInput.addEventListener('change', calculateDuration);
        endDateInput.addEventListener('change', calculateDuration);
    }
    
    // Enhanced Filter functionality
    const statusFilter = document.getElementById('statusFilter');
    const startDateFilter = document.getElementById('startDateFilter');
    const endDateFilter = document.getElementById('endDateFilter');
    const searchInput = document.getElementById('searchInput');
    const clearFilters = document.getElementById('clearFilters');
    const leavesTable = document.getElementById('leavesTable');
    const visibleCount = document.getElementById('visibleCount');
    
    // Clickable cards functionality
    const clickableCards = document.querySelectorAll('.clickable-card');
    clickableCards.forEach(card => {
        card.addEventListener('click', function() {
            const status = this.getAttribute('data-filter-status');
            
            // Reset all cards
            clickableCards.forEach(c => {
                c.style.transform = 'scale(1)';
                c.style.boxShadow = 'none';
            });
            
            // Highlight clicked card
            this.style.transform = 'scale(1.02)';
            this.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
            
            // Set filter values
            if (statusFilter) {
                statusFilter.value = status === 'all' ? '' : status;
            }
            
            if (startDateFilter) startDateFilter.value = '';
            if (endDateFilter) endDateFilter.value = '';
            if (searchInput) searchInput.value = '';
            
            filterTable();
        });
    });
    
    function filterTable() {
        const statusValue = statusFilter ? statusFilter.value.toLowerCase() : '';
        const startDateValue = startDateFilter ? startDateFilter.value : '';
        const endDateValue = endDateFilter ? endDateFilter.value : '';
        const searchValue = searchInput ? searchInput.value.toLowerCase() : '';
        
        const rows = leavesTable.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
        let visibleRows = 0;
        
        for (let row of rows) {
            const status = row.getAttribute('data-status') || '';
            const startDate = row.getAttribute('data-start-date') || '';
            const endDate = row.getAttribute('data-end-date') || '';
            const appliedDate = row.getAttribute('data-applied-date') || '';
            const text = row.textContent.toLowerCase();
            
            // Status filter
            const statusMatch = !statusValue || status === statusValue;
            
            // Date range filter (applied date)
            let dateMatch = true;
            if (startDateValue && endDateValue) {
                dateMatch = appliedDate >= startDateValue && appliedDate <= endDateValue;
            } else if (startDateValue) {
                dateMatch = appliedDate >= startDateValue;
            } else if (endDateValue) {
                dateMatch = appliedDate <= endDateValue;
            }
            
            // Search filter
            const searchMatch = !searchValue || text.includes(searchValue);
            
            const shouldShow = statusMatch && dateMatch && searchMatch;
            row.style.display = shouldShow ? '' : 'none';
            
            if (shouldShow) visibleRows++;
        }
        
        // Update visible count
        if (visibleCount) {
            visibleCount.textContent = visibleRows;
        }
        
        // Show/hide no results message
        const noResultsRow = leavesTable.querySelector('td[colspan]');
        if (noResultsRow) {
            noResultsRow.parentElement.style.display = visibleRows === 0 ? '' : 'none';
        }
    }
    
    // Event listeners for filters
    if (statusFilter) statusFilter.addEventListener('change', filterTable);
    if (startDateFilter) startDateFilter.addEventListener('change', filterTable);
    if (endDateFilter) endDateFilter.addEventListener('change', filterTable);
    if (searchInput) searchInput.addEventListener('input', filterTable);
    
    // Clear filters functionality
    if (clearFilters) {
        clearFilters.addEventListener('click', function() {
            if (statusFilter) statusFilter.value = '';
            if (startDateFilter) startDateFilter.value = '';
            if (endDateFilter) endDateFilter.value = '';
            if (searchInput) searchInput.value = '';
            
            // Reset cards
            clickableCards.forEach(card => {
                card.style.transform = 'scale(1)';
                card.style.boxShadow = 'none';
            });
            
            filterTable();
        });
    }
    
    // Set up reject leave buttons
    const rejectButtons = document.querySelectorAll('.reject-leave');
    rejectButtons.forEach(button => {
        button.addEventListener('click', function() {
            const leaveId = this.getAttribute('data-leave-id');
            setRejectLeaveId(leaveId);
        });
    });
    
    // Set up approve leave buttons
    const approveButtons = document.querySelectorAll('.approve-leave');
    approveButtons.forEach(button => {
        button.addEventListener('click', function() {
            const leaveId = this.getAttribute('data-leave-id');
            approveLeave(leaveId);
        });
    });
    
    // Initialize table filtering
    filterTable();
});

{% if is_admin %}
function approveLeave(leaveId) {
    if (confirm('Are you sure you want to approve this leave application?')) {
        const formData = new FormData();
        formData.append('leave_id', leaveId);
        formData.append('action', 'approve');
        
        fetch('{{ url_for("leave_action") }}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showAlert('Success!', data.message, 'success');
                // Close any open modals
                const openModals = document.querySelectorAll('.modal.show');
                openModals.forEach(modal => {
                    const bsModal = bootstrap.Modal.getInstance(modal);
                    if (bsModal) {
                        bsModal.hide();
                    }
                });
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                showAlert('Error!', data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error!', 'An error occurred while processing your request.', 'danger');
        });
    }
}

function confirmReject() {
    const leaveId = document.getElementById('rejectLeaveId').value;
    const rejectReason = document.getElementById('rejectReason').value;
    
    if (!rejectReason.trim()) {
        showAlert('Warning!', 'Please provide a reason for rejection.', 'warning');
        return;
    }
    
    const formData = new FormData();
    formData.append('leave_id', leaveId);
    formData.append('action', 'reject');
    formData.append('reject_reason', rejectReason);
    
    fetch('{{ url_for("leave_action") }}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Close reject modal
            const rejectModal = bootstrap.Modal.getInstance(document.getElementById('rejectLeaveModal'));
            if (rejectModal) {
                rejectModal.hide();
            }
            
            // Close any other open modals
            const openModals = document.querySelectorAll('.modal.show');
            openModals.forEach(modal => {
                const bsModal = bootstrap.Modal.getInstance(modal);
                if (bsModal) {
                    bsModal.hide();
                }
            });
            
            showAlert('Success!', data.message, 'success');
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            showAlert('Error!', data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error!', 'An error occurred while processing your request.', 'danger');
    });
}

function showAlert(title, message, type) {
    // Remove any existing alerts
    const existingAlerts = document.querySelectorAll('.alert-dismissible');
    existingAlerts.forEach(alert => alert.remove());
    
    const alertClass = type === 'success' ? 'alert-success' : 
                      type === 'error' ? 'alert-danger' : 
                      type === 'warning' ? 'alert-warning' : 'alert-info';
    
    const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
            <strong>${title}</strong> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    document.body.insertAdjacentHTML('afterbegin', alertHtml);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        const alert = document.querySelector('.alert-dismissible');
        if (alert) {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        }
    }, 5000);
}
{% endif %}
</script>
{% endblock %}